## Компоненты

- **`parser.py`** - основной парсер, собирает данные через API Power BI (type hints для mypy)
- **`runner.py`** - оркестратор, управляет батчами парсера и трансформацией (type hints для mypy --strict)
- **`transform_metrics_areas.py`** - преобразует сырые данные в финальный формат (type hints для mypy --strict)
- **`config.json`** - централизованная конфигурация парсера
- **`mypy.ini`** - конфигурация для проверки типов (mypy)

### Архитектура батчей

Runner автоматически разбивает районы на батчи:
- **Входной файл**: `all_areas.txt` содержит полный список всех районов (один на строку)
- **Размер батча**: Определяется параметром `batch_size` в config.json (по умолчанию 30 районов)
- **Автоматическое разделение**: Runner загружает все районы и разбивает их на батчи по 30
- **Независимые сессии**: Каждый батч запускается с отдельной сессией браузера для повышения надежности
- **Последовательная обработка**: Батчи обрабатываются один за другим

**Пример**: Если в файле 91 район, будут созданы 3 батча:
- Батч 1: 30 районов
- Батч 2: 30 районов  
- Батч 3: 31 район

### Решение проблемы с кэшированием Business Bay

**Проблема**: При загрузке дашборда по умолчанию выбран район "Business Bay". Браузер кэширует API-ответы для этого района. Когда очередь парсера доходит до Business Bay, браузер **не делает** новые запросы, берёт данные из кэша, и парсер их не перехватывает.

**Решение реализованное в парсере**:
1. Перед основным циклом обработки районов парсер обрабатывает дефолтный район (**Business Bay**)
2. В этот момент браузер уже показывает его данные → парсер успешно перехватывает запросы
3. Затем обрабатывает остальные районы из `areas.txt`, автоматически пропуская дефолтный
4. Параметр `default_area` в конфиге позволяет менять дефолтный район если нужно

**Пример flow**:
```
1. Загрузка дашборда → Business Bay загружается по умолчанию
2. [PROCESSING] Business Bay (перехватываем его данные прямо сейчас)
3. [PROCESSING] The Lakes
4. [PROCESSING] The Springs and The Meadows
... (остальные районы)
```

- Батч 3: 31 район

### Device ID

Device ID сохраняется в local storage браузера после первой авторизации. Чтобы получить свой device ID:

1. Авторизуйтесь вручную в Power BI дашборде
2. Откройте Browser DevTools (F12)
3. Перейдите в Application → Local Storage
4. Найдите ключ `deviceId`
5. Скопируйте значение и подставьте в config.json

## Конфигурация

### Файл config.json

Все параметры парсера находятся в `config.json`:

```json
{
  "auth": {
    "device_id": "123456789",
    "username": "...@gmail.com",
    "password": "YOUR_PASSWORD"
  },
  "areas_file": "all_areas.txt",
  "batch_size": 30,
  "auto": false,
  "date_settings": {
    "start_date": "23.11.2025",
    "end_date": "24.11.2025",
    "everyday": false
  },
  "output_raw_file": "metrics_raw.json",
  "output_merged_file": "metrics_merged.json",
  "output_final_file": "metrics_final.json"
}
```

### Параметры конфигурации

#### `auth` (object)
Параметры аутентификации для Power BI:

- **`device_id`** (строка): ID устройства для авторизации
- **`username`** (строка): Email для входа в Power BI
- **`password`** (строка): Пароль для входа в Power BI

#### `areas_file` (строка)
Имя файла со всеми районами для обработки. Каждый район должен быть на отдельной строке.

#### `batch_size` (число)
Максимальное количество районов в одном батче (по умолчанию 30).

#### `default_area` (строка) *(опционально)*
Название района, который загружается по умолчанию при открытии дашборда (по умолчанию `Business Bay`).

**Назначение**: Решает проблему с кэшированием запросов. Дашборд автоматически загружает один район по умолчанию. Парсер обрабатывает этот район **до** остального списка, когда его данные уже на экране и готовы к перехвату. Затем обрабатывает остальные районы из `areas.txt`, пропуская дефолтный, чтобы избежать повторной обработки и проблем с кэшем.

#### `date_settings` (object)

- **`start_date`** (строка, формат DD.MM.YYYY): Начальная дата для сбора данных
- **`end_date`** (строка, формат DD.MM.YYYY): Конечная дата для сбора данных
- **`everyday`** (boolean): Режим обработки дат
  - `true` - сбор ежедневных снимков для каждого дня в диапазоне
  - `false` - один снимок за весь диапазон дат (от start_date до end_date)

#### `output_raw_file` (строка)
Имя файла для сохранения сырых данных с ответами API.

#### `output_merged_file` (строка)
Имя файла для объединённых данных всех батчей.

#### `output_final_file` (строка)
Имя файла для финального трансформированного результата.

#### `auto` (boolean) *(опционально)*
Режим работы парсера:
- `true` - автоматический режим: парсер сам вычисляет прошлую полную неделю (пн-вс) и собирает 7 ежедневных снимков. Имя файла генерируется автоматически как `week_DD_MM_YYYY-DD_MM_YYYY.json`
- `false` - ручной режим: используются даты из `date_settings`

**Примечание**: Когда `auto: true`, параметры `date_settings` и `output_final_file` игнорируются (по умолчанию `false`).

## Использование

### Быстрый старт

Запустите главный скрипт:

```bash
python runner.py
```

Процесс:
1. Парсер загружает конфиг из config.json
2. Валидирует файлы районов
3. Запускает парсер для каждого батча последовательно
4. Объединяет результаты
5. Выполняет трансформацию
6. Сохраняет финальный результат

### Примеры конфигураций

#### Пример 1: Ежедневные снимки за неделю

```json
{
  "date_settings": {
    "start_date": "23.11.2025",
    "end_date": "29.11.2025",
    "everyday": true
  },
  "output_raw_file": "metrics_weekly_raw.json",
  "output_final_file": "metrics_weekly.json"
}
```

Результат: 7 ежедневных снимков (по одному за каждый день).

#### Пример 2: Один снимок за диапазон

```json
{
  "date_settings": {
    "start_date": "23.11.2025",
    "end_date": "29.11.2025",
    "everyday": false
  },
  "output_raw_file": "metrics_range_raw.json",
  "output_final_file": "metrics_range.json"
}
```

Результат: 1 снимок, содержащий сводную статистику за весь диапазон (23.11.2025 - 29.11.2025).

#### Пример 3: Один день

```json
{
  "date_settings": {
    "start_date": "29.11.2025",
    "end_date": "29.11.2025",
    "everyday": false
  }
}
```

#### Пример 4: Автоматический режим (прошлая неделя)

```json
{
  "auto": true
}
```

Результат: Парсер автоматически вычислит прошлую полную неделю (пн-вс) и создаст файл вида `week_24_11_2025-30_11_2025.json` с 7 ежедневными снимками для всех районов.

## Формат выходных данных

### Структура финального файла

```json
{
  "23.11.2025": {
    "The Lakes": {
      "sales_listing_volume": 3.0,
      "rent_listing_volume": 0.0,
      "sales_volume": {
        "ready_properties": 0.0,
        "off_plan_properties": 0.0
      },
      "sales_listing_avg_price": 3418.2,
      "rent_listing_avg_price": 0.0,
      "sales_avg_price": {
        "ready_properties": 0.0,
        "off_plan_properties": 0.0
      },
      "rent_volume": {
        "renewed_rentals": 0.0,
        "new_rentals": 0.0
      },
      "rent_avg_price": {
        "new_rentals": 0.0,
        "renewed_rentals": 0.0
      }
    }
  }
}
```

## Управление районами

### Файл all_areas.txt

Содержит полный список районов, по одному на строку:

```
The Lakes
Jebel Ali
Bur Dubai
Downtown Dubai
...
```

### Добавление новых районов

1. Отредактируйте файл `all_areas.txt`
2. Добавьте названия новых районов, по одному на строку
3. Сохраните файл
4. Запустите парсер - он автоматически разделит все районы на батчи

### Исключение районов

Просто удалите строку с названием района из `all_areas.txt`. Парсер будет работать только с оставшимися районами.

### Изменение размера батча

Измените параметр `batch_size` в config.json:

```json
{
  "batch_size": 20
}
```

Парсер автоматически создаст батчи нужного размера.

## Проверка типов (Type Hints)

Все основные файлы содержат полные аннотации типов для проверки с помощью mypy:

### Проверка типов

```bash
mypy runner.py --strict
mypy transform_metrics_areas.py --strict
```

### Конфигурация mypy

Файл `mypy.ini` содержит конфигурацию для проверки типов:
- Python версия: 3.9+
- Playwright импорты игнорируются (нет type stubs)
- Все остальные типы проверяются в strict режиме

## Обработка ошибок

### Пустой файл all_areas.txt

Если файл `all_areas.txt` пуст, парсер выведет ошибку:

```
[ERROR] Файл all_areas.txt пуст
```

**Решение**: Добавьте районы в файл.

## Структура проекта

```
Parsing Reidin/
├── parser.py                      # Основной парсер (с type hints)
├── runner.py                      # Оркестратор (с type hints)
├── transform_metrics_areas.py     # Трансформер данных (с type hints)
├── config.json                    # Конфигурация
├── mypy.ini                       # Конфигурация для mypy
├── requirements.txt               # Зависимости Python
├── README.md                      # Документация
├── all_areas.txt                  # Все районы (один на строку)
├── areas.txt                      # Временный файл (районы текущего батча)
├── metrics_*_raw.json             # Сырые данные API
├── metrics_*_merged.json          # Объединённые данные
└── *.json                         # Финальные данные (автоматическое имя)
```

## Логирование

Парсер выводит подробные логи процесса обработки:

```
======================================================================
[START] Главный скрипт запуска парсера Reidin
[TIME] 2025-12-02 15:52:33
======================================================================

[INFO] Загружаю config.json...
[INFO] Режим: AUTO
[INFO] Автоматический режим: прошлая неделя (24.11.2025 - 30.11.2025)

[INFO] Параметры дат:
  Start: 24.11.2025
  End: 30.11.2025
  Everyday: True

[OK] Загружено 91 районов из all_areas.txt
[OK] Разбито на 4 батчей по 30 районов

======================================================================
[BATCH 1/4] Обработка 30 районов
[OUTPUT] Raw file: metrics_raw.json
[DATES] 24.11.2025 - 30.11.2025 (everyday: True)
======================================================================

[OK] Батч 1 завершен успешно

...

[BATCH 4/4] Обработка 1 районов
[OUTPUT] Raw file: metrics_raw.json
[DATES] 24.11.2025 - 30.11.2025 (everyday: True)
======================================================================

[OK] Батч 4 завершен успешно

======================================================================
[MERGE] Объединяю результаты...
[INPUT] metrics_raw.json (один для каждого батча)
[OUTPUT] metrics_merged.json
======================================================================

[OK] Объединение завершено!
  Дат: 7
  Всего уникальных районов: 91
  Файл: metrics_merged.json

======================================================================
[TRANSFORM] Запуск трансформации...
======================================================================

[OK] Трансформация завершена успешно

======================================================================
[FINISH] Завершено!
[TIME] 2025-12-02 16:57:55
======================================================================

Финальный результат: week_24_11_2025-30_11_2025.json
  Дат: 7
  Районов: 91
```

## Лицензия

Приватный проект.

## Поддержка

Для вопросов и проблем зовите @zont1kk.
